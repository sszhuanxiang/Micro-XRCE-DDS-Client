From 3d9baf0875ff158fb72831e11e9aee1ab4c1a0ed Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?=E5=AD=99=E5=B8=85240108?= <2922139828@xiaomi.com>
Date: Tue, 4 Jun 2024 17:21:15 +0800
Subject: [PATCH] ss_homework

---
 CMakeLists.txt                              |   1 +
 examples/PubStudentInfo/CMakeLists.txt      |  49 +++++++
 examples/PubStudentInfo/StudentInfoType.c   |  63 ++++++++
 examples/PubStudentInfo/StudentInfoType.h   |  57 ++++++++
 examples/PubStudentInfo/StudentInfoType.idl |   5 +
 examples/PubStudentInfo/main.c              | 154 ++++++++++++++++++++
 6 files changed, 329 insertions(+)
 create mode 100644 examples/PubStudentInfo/CMakeLists.txt
 create mode 100644 examples/PubStudentInfo/StudentInfoType.c
 create mode 100644 examples/PubStudentInfo/StudentInfoType.h
 create mode 100644 examples/PubStudentInfo/StudentInfoType.idl
 create mode 100644 examples/PubStudentInfo/main.c

diff --git a/CMakeLists.txt b/CMakeLists.txt
index be0dcdd..563cf4c 100755
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -406,6 +406,7 @@ if(UCLIENT_BUILD_EXAMPLES)
     add_subdirectory(examples/MultiSessionHelloWorld)
     add_subdirectory(examples/PublishHelloWorld)
     add_subdirectory(examples/PublishHelloWorldP2P)
+    add_subdirectory(examples/PubStudentInfo)
     add_subdirectory(examples/ReplyAdder)
     add_subdirectory(examples/RequestAdder)
     add_subdirectory(examples/ShapesDemo)
diff --git a/examples/PubStudentInfo/CMakeLists.txt b/examples/PubStudentInfo/CMakeLists.txt
new file mode 100644
index 0000000..1149e49
--- /dev/null
+++ b/examples/PubStudentInfo/CMakeLists.txt
@@ -0,0 +1,49 @@
+# Copyright 2017 Proyectos y Sistemas de Mantenimiento SL (eProsima).
+#
+# Licensed under the Apache License, Version 2.0 (the "License");
+# you may not use this file except in compliance with the License.
+# You may obtain a copy of the License at
+#
+#     http://www.apache.org/licenses/LICENSE-2.0
+#
+# Unless required by applicable law or agreed to in writing, software
+# distributed under the License is distributed on an "AS IS" BASIS,
+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+# See the License for the specific language governing permissions and
+# limitations under the License.
+
+cmake_minimum_required(VERSION 2.8.12)
+if (${CMAKE_VERSION} VERSION_GREATER 3.0)
+    cmake_policy(SET CMP0048 NEW)
+endif()
+
+project(PublishStudentInfoClient C)
+
+if(NOT UCLIENT_BUILD_EXAMPLES)
+    find_package(microxrcedds_client REQUIRED)
+endif()
+
+if(NOT UCLIENT_PROFILE_UDP)
+    message(WARNING "Can not compile example: The UCLIENT_PROFILE_UDP must be enabled.")
+else()
+    add_executable(${PROJECT_NAME} main.c StudentInfoType.c)
+    if(MSVC OR MSVC_IDE)
+        target_compile_options(${PROJECT_NAME} PRIVATE /wd4996)
+    endif()
+
+    set_target_properties(${PROJECT_NAME} PROPERTIES
+        C_STANDARD 99
+        C_STANDARD_REQUIRED YES
+        )
+
+    target_link_libraries(${PROJECT_NAME} microxrcedds_client $<$<C_COMPILER_ID:GNU>:-Wl,--gc-section,--no-export-dynamic>)
+
+    if(UCLIENT_INSTALL_EXAMPLES)
+        install(
+            TARGETS
+                ${PROJECT_NAME}
+            RUNTIME DESTINATION
+                ${BIN_INSTALL_DIR}
+            )
+    endif()
+endif()
diff --git a/examples/PubStudentInfo/StudentInfoType.c b/examples/PubStudentInfo/StudentInfoType.c
new file mode 100644
index 0000000..84c7c7c
--- /dev/null
+++ b/examples/PubStudentInfo/StudentInfoType.c
@@ -0,0 +1,63 @@
+// Copyright 2016 Proyectos y Sistemas de Mantenimiento SL (eProsima).
+//
+// Licensed under the Apache License, Version 2.0 (the "License");
+// you may not use this file except in compliance with the License.
+// You may obtain a copy of the License at
+//
+//     http://www.apache.org/licenses/LICENSE-2.0
+//
+// Unless required by applicable law or agreed to in writing, software
+// distributed under the License is distributed on an "AS IS" BASIS,
+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+// See the License for the specific language governing permissions and
+// limitations under the License.
+
+/*!
+ * @file StudentInfoType.c
+ * This source file contains the definition of the described types in the IDL file.
+ *
+ * This file was generated by the tool gen.
+ */
+
+#include "StudentInfoType.h"
+
+#include <ucdr/microcdr.h>
+#include <string.h>
+
+bool StudentInfoType_serialize_topic(ucdrBuffer* writer, const StudentInfoType* topic)
+{
+    bool success = true;
+
+        success &= ucdr_serialize_string(writer, topic->name);
+
+        success &= ucdr_serialize_int32_t(writer, topic->id);
+
+        success &= ucdr_serialize_string(writer, topic->date);
+
+    return success && !writer->error;
+}
+
+bool StudentInfoType_deserialize_topic(ucdrBuffer* reader, StudentInfoType* topic)
+{
+    bool success = true;
+
+        success &= ucdr_deserialize_string(reader, topic->name, 255);
+
+        success &= ucdr_deserialize_int32_t(reader, &topic->id);
+
+        success &= ucdr_deserialize_string(reader, topic->date, 255);
+
+    return success && !reader->error;
+}
+
+uint32_t StudentInfoType_size_of_topic(const StudentInfoType* topic, uint32_t size)
+{
+    uint32_t previousSize = size;
+        size += ucdr_alignment(size, 4) + 4 + (uint32_t)strlen(topic->name) + 1;
+
+        size += ucdr_alignment(size, 4) + 4;
+
+        size += ucdr_alignment(size, 4) + 4 + (uint32_t)strlen(topic->date) + 1;
+
+    return size - previousSize;
+}
diff --git a/examples/PubStudentInfo/StudentInfoType.h b/examples/PubStudentInfo/StudentInfoType.h
new file mode 100644
index 0000000..1d1af8f
--- /dev/null
+++ b/examples/PubStudentInfo/StudentInfoType.h
@@ -0,0 +1,57 @@
+// Copyright 2016 Proyectos y Sistemas de Mantenimiento SL (eProsima).
+//
+// Licensed under the Apache License, Version 2.0 (the "License");
+// you may not use this file except in compliance with the License.
+// You may obtain a copy of the License at
+//
+//     http://www.apache.org/licenses/LICENSE-2.0
+//
+// Unless required by applicable law or agreed to in writing, software
+// distributed under the License is distributed on an "AS IS" BASIS,
+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+// See the License for the specific language governing permissions and
+// limitations under the License.
+
+/*!
+ * @file StudentInfoType.h
+ * This header file contains the declaration of the described types in the IDL file.
+ *
+ * This file was generated by the tool gen.
+ */
+
+#ifndef _StudentInfoType_H_
+#define _StudentInfoType_H_
+
+#ifdef __cplusplus
+extern "C"
+{
+#endif
+
+#include <stdint.h>
+#include <stdbool.h>
+
+/*!
+ * @brief This struct represents the structure StudentInfoType defined by the user in the IDL file.
+ * @ingroup StudentInfoType
+ */
+typedef struct StudentInfoType
+{
+    char name[255];
+
+    int32_t id;
+    char date[255];
+
+} StudentInfoType;
+
+struct ucdrBuffer;
+
+bool StudentInfoType_serialize_topic(struct ucdrBuffer* writer, const StudentInfoType* topic);
+bool StudentInfoType_deserialize_topic(struct ucdrBuffer* reader, StudentInfoType* topic);
+uint32_t StudentInfoType_size_of_topic(const StudentInfoType* topic, uint32_t size);
+
+
+#ifdef __cplusplus
+}
+#endif
+
+#endif // _StudentInfoType_H_
\ No newline at end of file
diff --git a/examples/PubStudentInfo/StudentInfoType.idl b/examples/PubStudentInfo/StudentInfoType.idl
new file mode 100644
index 0000000..e333616
--- /dev/null
+++ b/examples/PubStudentInfo/StudentInfoType.idl
@@ -0,0 +1,5 @@
+struct StudentInfoType{
+    string          name;
+    long            id;
+    string          date;
+};
\ No newline at end of file
diff --git a/examples/PubStudentInfo/main.c b/examples/PubStudentInfo/main.c
new file mode 100644
index 0000000..40aea72
--- /dev/null
+++ b/examples/PubStudentInfo/main.c
@@ -0,0 +1,154 @@
+// Copyright 2017 Proyectos y Sistemas de Mantenimiento SL (eProsima).
+//
+// Licensed under the Apache License, Version 2.0 (the "License");
+// you may not use this file except in compliance with the License.
+// You may obtain a copy of the License at
+//
+//     http://www.apache.org/licenses/LICENSE-2.0
+//
+// Unless required by applicable law or agreed to in writing, software
+// distributed under the License is distributed on an "AS IS" BASIS,
+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+// See the License for the specific language governing permissions and
+// limitations under the License.
+
+#include "StudentInfoType.h"
+
+#include <uxr/client/client.h>
+#include <ucdr/microcdr.h>
+
+#include <stdio.h> //printf
+#include <string.h> //strcmp
+#include <stdlib.h> //atoi
+
+#define STREAM_HISTORY  8
+#define BUFFER_SIZE     UXR_CONFIG_UDP_TRANSPORT_MTU* STREAM_HISTORY
+
+int main(
+        int args,
+        char** argv)
+{
+    // CLI
+    if (3 > args || 0 == atoi(argv[2]))
+    {
+        printf("usage: program [-h | --help] | ip port [<max_topics>]\n");
+        return 0;
+    }
+
+    char* ip = argv[1];
+    char* port = argv[2];
+    uint32_t max_topics = (args == 4) ? (uint32_t)atoi(argv[3]) : UINT32_MAX;
+
+    // Transport
+    uxrUDPTransport transport;
+    if (!uxr_init_udp_transport(&transport, UXR_IPv4, ip, port))
+    {
+        printf("Error at create transport.\n");
+        return 1;
+    }
+
+    // Session
+    uxrSession session;
+    uxr_init_session(&session, &transport.comm, 0xAAAABBBB);
+    if (!uxr_create_session(&session))
+    {
+        printf("Error at create session.\n");
+        return 1;
+    }
+
+    // Streams
+    uint8_t output_reliable_stream_buffer[BUFFER_SIZE];
+    uxrStreamId reliable_out = uxr_create_output_reliable_stream(&session, output_reliable_stream_buffer, BUFFER_SIZE,
+                    STREAM_HISTORY);
+
+    uint8_t input_reliable_stream_buffer[BUFFER_SIZE];
+    uxr_create_input_reliable_stream(&session, input_reliable_stream_buffer, BUFFER_SIZE, STREAM_HISTORY);
+
+    // Create entities
+    uxrObjectId participant_id = uxr_object_id(0x01, UXR_PARTICIPANT_ID);
+    const char* participant_xml = "<dds>"
+            "<participant>"
+            "<rtps>"
+            "<name>default_xrce_participant</name>"
+            "</rtps>"
+            "</participant>"
+            "</dds>";
+    uint16_t participant_req = uxr_buffer_create_participant_xml(&session, reliable_out, participant_id, 0,
+                    participant_xml, UXR_REPLACE);
+
+    uxrObjectId topic_id = uxr_object_id(0x01, UXR_TOPIC_ID);
+    const char* topic_xml = "<dds>"
+            "<topic>"
+            "<name>StudentInfo</name>"
+            "<dataType>StudentInfoType</dataType>"
+            "</topic>"
+            "</dds>";
+    uint16_t topic_req = uxr_buffer_create_topic_xml(&session, reliable_out, topic_id, participant_id, topic_xml,
+                    UXR_REPLACE);
+
+    uxrObjectId publisher_id = uxr_object_id(0x01, UXR_PUBLISHER_ID);
+    const char* publisher_xml = "";
+    uint16_t publisher_req = uxr_buffer_create_publisher_xml(&session, reliable_out, publisher_id, participant_id,
+                    publisher_xml, UXR_REPLACE);
+
+    uxrObjectId datawriter_id = uxr_object_id(0x01, UXR_DATAWRITER_ID);
+    const char* datawriter_xml = "<dds>"
+            "<data_writer>"
+            "<topic>"
+            "<kind>NO_KEY</kind>"
+            "<name>StudentInfo</name>"
+            "<dataType>StudentInfoType</dataType>"
+            "</topic>"
+            "</data_writer>"
+            "</dds>";
+    uint16_t datawriter_req = uxr_buffer_create_datawriter_xml(&session, reliable_out, datawriter_id, publisher_id,
+                    datawriter_xml, UXR_REPLACE);
+
+    // Send create entities message and wait its status
+    uint8_t status[4];
+    uint16_t requests[4] = {
+        participant_req, topic_req, publisher_req, datawriter_req
+    };
+    if (!uxr_run_session_until_all_status(&session, 1000, requests, status, 4))
+    {
+        printf("Error at create entities: participant: %i topic: %i publisher: %i datawriter: %i\n", status[0],
+                status[1], status[2], status[3]);
+        return 1;
+    }
+
+    // Write topics
+    bool connected = true;
+    //uint32_t count = 0;
+    // while (connected && count < max_topics)
+    // {
+    //     HelloWorld topic = {
+    //         ++count, "Hello DDS world!"
+    //     };
+
+    //     ucdrBuffer ub;
+    //     uint32_t topic_size = HelloWorld_size_of_topic(&topic, 0);
+    //     uxr_prepare_output_stream(&session, reliable_out, datawriter_id, &ub, topic_size);
+    //     HelloWorld_serialize_topic(&ub, &topic);
+
+    //     printf("Send topic: %s, id: %i\n", topic.message, topic.index);
+    //     connected = uxr_run_session_time(&session, 1000);
+    // }
+    StudentInfoType topic= {
+        "sunshuai",2021210863,"2003.12.05"
+    };
+
+    ucdrBuffer ub;
+    uint32_t topic_size = StudentInfoType_size_of_topic(&topic, 0);
+    uxr_prepare_output_stream(&session, reliable_out, datawriter_id, &ub, topic_size);
+    StudentInfoType_serialize_topic(&ub, &topic);
+
+    printf("Student info---> name: %s, id: %ld, date: %s\n",topic.name, topic.id, topic.date);
+
+    connected = uxr_run_session_time(&session, 1000);
+
+    // Delete resources
+    uxr_delete_session(&session);
+    uxr_close_udp_transport(&transport);
+
+    return 0;
+}
-- 
2.34.1

